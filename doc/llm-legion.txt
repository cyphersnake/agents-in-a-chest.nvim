*llm-legion.txt*  Launch LLM coding agents in isolated Git worktrees

Author:  cyphersnake
License: MIT
Repo:    https://codeberg.org/cyphersnake/llm-legion.nvim

INTRODUCTION                                    *llm-legion*

llm-legion.nvim provides isolated Git worktree environments for LLM coding
agents. Each session runs in its own worktree outside your repository, with
automatic commit and cleanup on exit.

QUICK FLOW                                      *llm-legion-flow*

1. Start a few agents: >
    :LLMSession claude --name refactor-auth
    :LLMSession codex  --name add-tests --base develop
<
2. Work in each agent's tab (isolated worktrees).
3. Close each tab when finished. On close: auto-commit, then prompt to land
   via Neogit using cherry-pick -n with a prefilled message.
4. Complete the Neogit commit. The worktree is removed; the `llm/...` branch
   is preserved for provenance or later merging.

CONTENTS                                        *llm-legion-contents*

1. Commands.................................|llm-legion-commands|
2. Configuration............................|llm-legion-config|
3. Functions................................|llm-legion-functions|
4. Mappings.................................|llm-legion-mappings|

==============================================================================
COMMANDS                                        *llm-legion-commands*

                                                *:LLMSession*
:LLMSession {provider} --name {slug} [--base {ref}]
    Start a new LLM session with the specified provider.
    
    {provider}  Name of configured provider (e.g., 'claude', 'codex')
    {slug}      Human-readable name for the session (sanitized to [a-z0-9._-]+)
    {ref}       Optional Git ref to base worktree on (default: HEAD)
    
    Example: >
        :LLMSession claude --name refactor-auth --base develop
<
                                                *:LLMAbort*
:LLMAbort
    Abort the LLM session in the current tab. Triggers auto-commit and
    cleanup of the worktree.

                                                *:LLMCleanup*
:LLMCleanup
    Clean up orphaned worktree directories and prune Git metadata.
    Safe to run anytime.

                                               *:LLMEnd*
:LLMEnd
    End the current LLM session. If uncommitted changes exist in the
    session worktree, they are auto-committed first. Then, optionally
    land those changes onto the base branch via an interactive Neogit
    flow using `git cherry-pick -n` and a prefilled commit message.
    The worktree is removed after commit; the llm/... branch remains.
    
    Note: This finalize flow also runs automatically when the session
    terminal exits or the tab is closed. `:LLMEnd` is optional and
    provided in case you want to trigger it explicitly.

==============================================================================
CONFIGURATION                                   *llm-legion-config*

Setup function: >
    require('llm_legion').setup({
        -- options
    })
<
Options:

worktrees_root                          *llm-legion.worktrees_root*
    Type: `string|nil`
    Default: `nil` (auto-computed as <repo_parent>/.<repo_name>-worktrees)
    
    Custom location for worktree directories.

worktrees_prefix                        *llm-legion.worktrees_prefix*
    Type: `string|nil`
    Default: `nil` (uses repository name)
    
    Custom prefix for worktree directory names.

default_base                            *llm-legion.default_base*
    Type: `string`
    Default: `"HEAD"`
    
    Default Git ref for new worktrees.

providers                               *llm-legion.providers*
    Type: `table`
    Default: >
        {
            claude = { cmd = "claude", args = {} },
            codex = { cmd = "codex", args = {} }
        }
<
    Provider configurations. Each provider needs:
    - `cmd`: Command to execute
    - `args`: Optional arguments array

Rust projects                            *llm-legion.rust*
    Options for Rust/Cargo repositories. When enabled, sessions launched
    inside a Rust project export `CARGO_TARGET_DIR` so all worktrees share
    a single target directory at the repository root. This avoids repeated
    target rebuilds across Git worktrees and saves disk space: >
        rust = {
          share_target_dir = true,      -- default: true
          target_dir = nil,             -- default: <repo_root>/target
          env_name = "CARGO_TARGET_DIR",-- override env var name if needed
          detect = true,                -- detect via Cargo.toml or rust-toolchain*
        }
<
    Detection checks for `Cargo.toml`, `rust-toolchain`, or
    `rust-toolchain.toml` in the repository root. If `detect = false`, the
    target env is exported unconditionally for sessions in any repository.

Example configuration: >
    require('llm_legion').setup({
        worktrees_prefix = "ai",
        default_base = "main",
        providers = {
            claude = { 
                cmd = "claude",
                args = {} 
            },
            aider = {
                cmd = "aider",
                args = { "--yes-always" }
            }
        },
        rust = {
          share_target_dir = true,
          -- target_dir = "/path/to/shared/target", -- optional override
        }
    })
<

Landing (v0.2.0)                          *llm-legion.landing*
    Options controlling the end-of-session landing flow: >
        landing = {
          base_branch = "main",   -- target branch to land onto
          auto_prompt = true,      -- ask to land on :LLMEnd
        }
<
    Notes: ~
      - If `base_branch` is nil, the plugin detects a default branch via
        `origin/HEAD`, falling back to `main`, `master`, or the current.
      - The landing flow requires Neogit. If not installed, :LLMEnd errs.
      - Closing the LLM tab (or exiting its terminal) triggers landing
        automatically if `auto_prompt` is enabled (default: true).
==============================================================================
FUNCTIONS                                       *llm-legion-functions*

setup({config})                                 *llm_legion.setup()*
    Initialize the plugin with given configuration.
    
    Parameters: ~
        {config}  Optional configuration table

session_cmd({args})                             *llm_legion.session_cmd()*
    Internal function called by :LLMSession command.
    
    Parameters: ~
        {args}  Array of command arguments

abort_current()                                 *llm_legion.abort_current()*
    Abort session in current tab. Called by :LLMAbort.

cleanup()                                       *llm_legion.cleanup()*
    Clean up orphaned worktrees. Called by :LLMCleanup.

==============================================================================
MAPPINGS                                        *llm-legion-mappings*

No default mappings are provided. Example mappings: >
    vim.keymap.set("n", "<leader>lc", ":LLMSession claude --name refactor<CR>")
    vim.keymap.set("n", "<leader>lx", ":LLMSession codex --name tests<CR>")
    vim.keymap.set("n", "<leader>le", ":LLMEnd<CR>")       -- optional, closing the tab also ends
    vim.keymap.set("n", "<leader>la", ":LLMAbort<CR>")
<
==============================================================================
vim:tw=78:ts=8:ft=help:norl:
